var RegionesYcomunas = {"regiones": [{"NombreRegion": "Región de Arica y Parinacota",
"comunas": ["Arica", "Camarones", "Putre", "General Lagos"]},
{"NombreRegion": "Región de Tarapacá",
"comunas": ["Iquique", "Alto Hospicio", "Pozo Almonte", "Camiña", "Colchane", "Huara", "Pica"]},
{"NombreRegion": "Región de Antofagasta",
"comunas": ["Antofagasta", "Mejillones", "Sierra Gorda", "Taltal", "Calama", "Ollagüe", "San Pedro de Atacama",
	"Tocopilla", "María Elena"]},
{"NombreRegion": "Región de Atacama",
"comunas": ["Copiapó", "Caldera", "Tierra Amarilla", "Chañaral", "Diego de Almagro", "Vallenar", "Alto del Carmen",
	"Freirina", "Huasco"]},
{"NombreRegion": "Región de Coquimbo",
"comunas": ["La Serena", "Coquimbo", "Andacollo", "La Higuera", "Paiguano", "Vicuña", "Illapel", "Canela", "Los Vilos",
	"Salamanca", "Ovalle", "Combarbalá", "Monte Patria", "Punitaqui", "Río Hurtado"]},
{"NombreRegion": "Región de Valparaíso",
"comunas": ["Valparaíso", "Casablanca", "Concón", "Juan Fernández", "Puchuncaví", "Quintero", "Viña del Mar",
	"Isla de Pascua", "Los Andes", "Calle Larga", "Rinconada", "San Esteban", "La Ligua", "Cabildo", "Papudo",
	"Petorca", "Zapallar", "Quillota", "Calera", "Hijuelas", "La Cruz", "Nogales", "San Antonio", "Algarrobo",
	"Cartagena", "El Quisco", "El Tabo", "Santo Domingo", "San Felipe", "Catemu", "Llaillay", "Panquehue", "Putaendo",
	"Santa María", "Quilpué", "Limache", "Olmué", "Villa Alemana"]},
{"NombreRegion": "Región del Libertador Gral. Bernardo O’Higgins",
"comunas": ["Rancagua", "Codegua", "Coinco", "Coltauco", "Doñihue", "Graneros", "Las Cabras", "Machalí", "Malloa",
	"Mostazal", "Olivar", "Peumo", "Pichidegua", "Quinta de Tilcoco", "Rengo", "Requínoa", "San Vicente", "Pichilemu",
	"La Estrella", "Litueche", "Marchihue", "Navidad", "Paredones", "San Fernando", "Chépica", "Chimbarongo", "Lolol",
	"Nancagua", "Palmilla", "Peralillo", "Placilla", "Pumanque", "Santa Cruz"]},
{"NombreRegion": "Región del Maule",
"comunas": ["Talca", "Constitución", "Curepto", "Empedrado", "Maule", "Pelarco", "Pencahue", "Río Claro", "San Clemente",
	"San Rafael", "Cauquenes", "Chanco", "Pelluhue", "Curicó", "Hualañé", "Licantén", "Molina", "Rauco", "Romeral",
	"Sagrada Familia", "Teno", "Vichuquén", "Linares", "Colbún", "Longaví", "Parral", "Retiro", "San Javier",
	"Villa Alegre", "Yerbas Buenas"]},
{"NombreRegion": "Región del Biobío",
"comunas": ["Concepción", "Coronel", "Chiguayante", "Florida", "Hualqui", "Lota", "Penco", "San Pedro de la Paz",
	"Santa Juana", "Talcahuano", "Tomé", "Hualpén", "Lebu", "Arauco", "Cañete", "Contulmo", "Curanilahue", "Los Álamos",
	"Tirúa", "Los Ángeles", "Antuco", "Cabrero", "Laja", "Mulchén", "Nacimiento", "Negrete", "Quilaco", "Quilleco",
	"San Rosendo", "Santa Bárbara", "Tucapel", "Yumbel", "Alto Biobío", "Chillán", "Bulnes", "Cobquecura", "Coelemu",
	"Coihueco", "Chillán Viejo", "El Carmen", "Ninhue", "Ñiquén", "Pemuco", "Pinto", "Portezuelo", "Quillón",
	"Quirihue", "Ránquil", "San Carlos", "San Fabián", "San Ignacio", "San Nicolás", "Treguaco", "Yungay"]},
{"NombreRegion": "Región de la Araucanía",
"comunas": ["Temuco", "Carahue", "Cunco", "Curarrehue", "Freire", "Galvarino", "Gorbea", "Lautaro", "Loncoche",
	"Melipeuco", "Nueva Imperial", "Padre las Casas", "Perquenco", "Pitrufquén", "Pucón", "Saavedra", "Teodoro Schmidt",
	"Toltén", "Vilcún", "Villarrica", "Cholchol", "Angol", "Collipulli", "Curacautín", "Ercilla", "Lonquimay",
	"Los Sauces", "Lumaco", "Purén", "Renaico", "Traiguén", "Victoria", ]},
{"NombreRegion": "Región de Los Ríos",
"comunas": ["Valdivia", "Corral", "Lanco", "Los Lagos", "Máfil", "Mariquina", "Paillaco", "Panguipulli", "La Unión",
	"Futrono", "Lago Ranco", "Río Bueno"]},
{"NombreRegion": "Región de Los Lagos",
"comunas": ["Puerto Montt", "Calbuco", "Cochamó", "Fresia", "Frutillar", "Los Muermos", "Llanquihue", "Maullín",
	"Puerto Varas", "Castro", "Ancud", "Chonchi", "Curaco de Vélez", "Dalcahue", "Puqueldón", "Queilén", "Quellón",
	"Quemchi", "Quinchao", "Osorno", "Puerto Octay", "Purranque", "Puyehue", "Río Negro", "San Juan de la Costa",
	"San Pablo", "Chaitén", "Futaleufú", "Hualaihué", "Palena"]},
{"NombreRegion": "Región Aisén del Gral. Carlos Ibáñez del Campo",
"comunas": ["Coihaique", "Lago Verde", "Aisén", "Cisnes", "Guaitecas", "Cochrane", "O’Higgins", "Tortel", "Chile Chico",
	"Río Ibáñez"]},
{"NombreRegion": "Región de Magallanes",
"comunas": ["Punta Arenas", "Laguna Blanca", "Río Verde", "San Gregorio", "Cabo de Hornos (Ex Navarino)", "Antártica",
	"Porvenir", "Primavera", "Timaukel", "Natales", "Torres del Paine"]},
{"NombreRegion": "Región Metropolitana",
"comunas": ["Cerrillos", "Cerro Navia", "Conchalí", "El Bosque", "Estación Central", "Huechuraba", "Independencia",
	"La Cisterna", "La Florida", "La Granja", "La Pintana", "La Reina", "Las Condes", "Lo Barnechea", "Lo Espejo",
	"Lo Prado", "Macul", "Maipú", "Ñuñoa", "Pedro Aguirre Cerda", "Peñalolén", "Providencia", "Pudahuel", "Quilicura",
	"Quinta Normal", "Recoleta", "Renca", "San Joaquín", "San Miguel", "San Ramón", "Vitacura", "Puente Alto", "Pirque",
	"San José de Maipo", "Colina", "Lampa", "Tiltil", "San Bernardo", "Buin", "Calera de Tango", "Paine", "Melipilla",
	"Alhué", "Curacaví", "María Pinto", "San Pedro", "Talagante", "El Monte", "Isla de Maipo", "Padre Hurtado",
	"Peñaflor", "Santiago"]}]};
var archivosSeleccionados = 1;
var regionesYComunasMostradas = 0;

$('document').ready(function() {
	// Se esconden elementos cuya aparición solo es gatillada por acciones específicas realizadas en la página
	$('#más-espacio-necesario').hide();
	$('#foto-mascota2').hide();
	$('#foto-mascota3').hide();
	$('#foto-mascota4').hide();
	$('#foto-mascota5').hide();

	$('#más-espacio-disponible').hide();
	$('#extra1').hide();
	$('#extra2').hide();
	$('#extra3').hide();
	$('#extra4').hide();

	// Se inicializan los selectores de origen y destino con los valores de las regiones de Chile
	generarRegionesYComunas($('#region-origen'), $('#comuna-origen'));
	generarRegionesYComunas($('#region-destino'), $('#comuna-destino'));

	generarRegionesYComunas($('#region-disponible'), $('#comuna-disponible'));

	// Se inicializa el datepicker para escoger la fecha del viaje
	$('#fecha-viaje').datepicker({
        dateFormat: 'yy-mm-dd',
        minDate: new Date(),
		inline: true,
        showOtherMonths: true,
        dayNamesMin: ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'],
        monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre',
            'Noviembre', 'Diciembre']
	});

	// En caso de escoger la opción "más" como espacio necesario, se gatilla la aparición de un cuadro de texto para
	// ingresar el valor deseado
	$("#espacio-necesario").on("change", function(event) {
	    if($('#espacio-necesario').val() == "más") {
			$('#más-espacio-necesario').show();
		} else {
			$('#más-espacio-necesario').hide();
		}
    });

	// Al hacer click en el botón "agregar otro archivo", se gatilla la aparición de un nuevo elemento input de tipo
	// file que permita ingresar otro archivo, considerando un máximo de 5 archivos
	$('#agregar-otro-archivo').on("click", function() {
		archivosSeleccionados++;
		if(archivosSeleccionados <= 5) {
            var string = '#foto-mascota' + archivosSeleccionados;
            $(string).show();
        }
        if(archivosSeleccionados == 5) {
			$('#agregar-otro-archivo').hide();
		}
	});

	// Validación de formulario
	$('#enviar-traslado').on("click", function() {
		// Validación región de origen
	    if($('#region-origen').val() == null) {
			errorCampoVacio('#region-origen');
		} else {
	        errorCampoVacio('#region-origen', true);
        }
        // Validación comuna de origen
		if($('#comuna-origen').val() == null) {
			errorCampoVacio('#comuna-origen');
		} else {
		    errorCampoVacio('#comuna-origen', true);
        }

        // Validación región de destino
		if($('#region-destino').val() == null) {
			errorCampoVacio('#region-destino');
		} else {
		    errorCampoVacio('#region-destino', true);
        }
        // Validación comuna de destino
		if($('#comuna-destino').val() == null) {
			errorCampoVacio('#comuna-destino');
		} else {
		    errorCampoVacio('#comuna-destino', true);
        }

        // Validación fecha de viaje
        if($('#fecha-viaje').val() == "") {
        	errorCampoVacio('#fecha-viaje');
        	$('#fecha-viaje-span').text("Campo requerido");
        } else if(esFechaValida($('#fecha-viaje').val())) {
            errorCampoVacio('#fecha-viaje', true);
            $('#fecha-viaje-span').text("Campo requerido");
        } else {
            $('#fecha-viaje').css({"box-shadow": "0 0 3px #CC0000"});
            $('#fecha-viaje-span').text("Debe ingresar una fecha en el formato aaaa-mm-dd");
            $('#fecha-viaje-span').css({"display": "inline"});
        }
        // Validación espacio necesario
        if($('#espacio-necesario').val() == null) {
        	errorCampoVacio('#espacio-necesario');
        } else {
            errorCampoVacio('#espacio-necesario', true);
            if($('#espacio-necesario').val() == "más") {
            	// Validación más espacio necesario
                if($('#más-espacio-necesario-input').val() == "") {
                    errorCampoVacio('#más-espacio-necesario-input');
                } else {
                    errorCampoVacio('#más-espacio-necesario-input', true);
                }
            }
        }

        // Validación tipo de mascota
        if($('#tipo-mascota').val() == null) {
        	errorCampoVacio('#tipo-mascota');
        } else {
            errorCampoVacio('#tipo-mascota', true);
        }
        // Validación fotos mascota
        var fotosMascota = 0;
        if($('#foto-mascota').val() != "") {
        	fotosMascota++;
        }
        if($('#foto-mascota2').val() != "") {
        	fotosMascota++;
        }
        if($('#foto-mascota3').val() != "") {
        	fotosMascota++;
        }
        if($('#foto-mascota4').val() != "") {
        	fotosMascota++;
        }
        if($('#foto-mascota5').val() != "") {
        	fotosMascota++;
        }
        if(fotosMascota == 0) {
        	errorCampoVacio('#foto-mascota');
		} else {
            errorCampoVacio('#foto-mascota', true);
        }
        // Validación descripción mascota
        if($('#descripcion-mascota').val().length > 500) {
            errorCampoVacio('#descripcion-mascota');
        } else {
            errorCampoVacio('#descripcion-mascota', true);
        }

        // Validación nombre
		if($('#nombre').val() == "") {
        	errorCampoVacio('#nombre');
        	$('#nombre-span').text("Campo requerido");
        } else if($('#nombre').val().length < 3 || $('#nombre').val().length > 80) {
            $('#nombre').css({"box-shadow": "0 0 3px #CC0000"});
            $('#nombre-span').text("Debe ingresar un nombre de largo entre 3 y 80 caracteres");
            $('#nombre-span').css({"display": "inline"});
        } else {
		    errorCampoVacio('#nombre', true);
		    $('#nombre-span').text("Campo requerido");
        }
        // Validación email
        if($('#email').val() == "") {
        	errorCampoVacio('#email');
        	$('#email-span').text("Campo requerido");
        } else if(esEmailValido($('#email').val())) {
        	errorCampoVacio('#email', true);
            $('#email-span').text("Campo requerido");
        } else {
        	$('#email').css({"box-shadow": "0 0 3px #CC0000"});
            $('#email-span').text("Debe ingresar un email válido");
            $('#email-span').css({"display": "inline"});
        }

        // Validación celular
        if(esCelularValido($('#celular').val()) || $('#celular').val() == "") {
        	errorCampoVacio('#celular', true);
        } else {
        	errorCampoVacio('#celular');
        }
    });

	// En caso de escoger la opción "más" como espacio disponible, se gatilla la aparición de un cuadro de texto para
	// ingresar el valor deseado
	$("#espacio-disponible").on("change", function(event) {
	    if($('#espacio-disponible').val() == "más") {
			$('#más-espacio-disponible').show();
		} else {
			$('#más-espacio-disponible').hide();
		}
    });

	// Al hacer click en el botón "agregar otra comuna, se gatilla la aparición de dos elementos input que permiten
	// ingresar otra región y comuna, considerando un máximo de 5
	$('#agregar-otra-comuna').on("click", function() {
		regionesYComunasMostradas++;
		if(regionesYComunasMostradas <= 4) {
			var stringRegion = '#region-extra' + regionesYComunasMostradas;
			var stringComuna = '#comuna-extra' + regionesYComunasMostradas;
			generarRegionesYComunas($(stringRegion), $(stringComuna));
            var string = '#extra' + regionesYComunasMostradas;
            $(string).show();
        }
        if(regionesYComunasMostradas == 4) {
			$('#agregar-otra-comuna').hide();
		}
	});

	// Validación de formulario
	$('#enviar-voluntario').on("click", function() {
		// Validación nombre
		if($('#nombre-voluntario').val() == "") {
        	errorCampoVacio('#nombre-voluntario');
        	$('#nombre-voluntario-span').text("Campo requerido");
        } else if($('#nombre-voluntario').val().length > 80) {
            $('#nombre-voluntario').css({"box-shadow": "0 0 3px #CC0000"});
            $('#nombre-voluntario-span').text("Debe ingresar un nombre con un largo de 80 caracteres o menos");
            $('#nombre-voluntario-span').css({"display": "inline"});
        } else {
		    errorCampoVacio('#nombre-voluntario', true);
		    $('#nombre-voluntario-span').text("Campo requerido");
        }

        // Validación email
        if($('#email-voluntario').val() == "") {
        	errorCampoVacio('#email-voluntario');
        	$('#email-voluntario-span').text("Campo requerido");
        } else if(esEmailValido($('#email-voluntario').val())) {
        	errorCampoVacio('#email-voluntario', true);
            $('#email-voluntario-span').text("Campo requerido");
        } else {
        	$('#email-voluntario').css({"box-shadow": "0 0 3px #CC0000"});
            $('#email-voluntario-span').text("Debe ingresar un email válido");
            $('#email-voluntario-span').css({"display": "inline"});
        }

         // Validación celular
        if(esCelularValido($('#celular-voluntario').val()) || $('#celular-voluntario').val() == "") {
        	errorCampoVacio('#celular-voluntario', true);
        } else {
        	errorCampoVacio('#celular-voluntario');
        }

        // Validación espacio disponible
        if($('#espacio-disponible').val() == null) {
        	errorCampoVacio('#espacio-disponible');
        } else {
            errorCampoVacio('#espacio-disponible', true);
            if($('#espacio-disponible').val() == "más") {
            	// Validación más espacio disponible
                if($('#más-espacio-disponible-input').val() == "") {
                    errorCampoVacio('#más-espacio-disponible-input');
                } else {
                    errorCampoVacio('#más-espacio-disponible-input', true);
                }
            }
        }

        // Validación región disponible
		if($('#region-disponible').val() == null) {
			errorCampoVacio('#region-disponible');
		} else {
		    errorCampoVacio('#region-disponible', true);
        }
        // Validación comuna disponible
		if($('#comuna-disponible').val() == null) {
			errorCampoVacio('#comuna-disponible');
		} else {
		    errorCampoVacio('#comuna-disponible', true);
        }

        // Validación regiones y comunas extra
		if(regionesYComunasMostradas > 0) {
			for(var i = 1; i <= regionesYComunasMostradas; i++) {
				var stringRegion = '#region-extra' + i;
				var stringComuna = '#comuna-extra' + i;
				if ($(stringRegion).val() != null && $(stringComuna).val() == null) {
					errorCampoVacio(stringComuna);
                } else {
					errorCampoVacio(stringComuna, true);
				}
			}
		}

        // Validación descripción voluntario
        if($('#descripcion-voluntario').val().length > 500) {
            errorCampoVacio('#descripcion-voluntario');
        } else {
            errorCampoVacio('#descripcion-voluntario', true);
        }
    });

	// Clicks en imágenes de mascotas
	$('#traslado1-imagen').on("click", function() {
		configurarModal('#myModal1', 0);
	});
	$('#traslado2-1-imagen').on("click", function() {
		configurarModal('#myModal2-1', 0);
	});
	$('#traslado2-2-imagen').on("click", function() {
		configurarModal('#myModal2-2', 1);
	});
	$('#traslado3-imagen').on("click", function() {
		configurarModal('#myModal3', 0);
	});
	$('#traslado4-imagen').on("click", function() {
		configurarModal('#myModal4', 0);
	});
	$('#traslado5-imagen').on("click", function() {
		configurarModal('#myModal5', 0);
	});

	var miMapa = L.map('mapa').setView([-33.4372, -70.6506], 13);
	L.marker([-33.4372, -70.6506]).addTo(miMapa);
	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
		maxZoom: 18,
		id: 'mapbox.streets',
		accessToken: 'pk.eyJ1IjoicGlzYzFzIiwiYSI6ImNqdjMzd3J0bjAzdG4zeWxiYmR6M3Vtb3IifQ.maMdRyOIicEmjJ69iKRkQg'
	}).addTo(miMapa);
});

/**
 * Función que se encarga de mostrar un modal con una imagen de mayor tamaño a la original
 * @param id
 * @param i
 */
function configurarModal(id, i) {
	$(id).css({"display": "block"});
	var span = document.getElementsByClassName("close")[i];
	span.onclick = function() {
		$(id).css({"display": "none"});
	}
	window.onclick = function(event) {
	  if ('#' + event.target.id == id) {
		$(id).css({"display": "none"});
	  }
	}
}

/**
 * Función que utiliza una expresión regular para validar que el valor ingresado corresponda a un celular de Chile en el
 * formato +56911111111
 * @param celular
 * @returns {*|boolean}
 */
function esCelularValido(celular) {
	var exprReg = /^(\+?56)?(\s?)(0?9)(\s?)[987654321]\d{7}$/;
	return exprReg.test(celular);
}

/**
 * Función que utiliza una expresión regular para comprobar que el formato del email ingresado sea válido
 * @param email
 * @returns {*|boolean}
 */
function esEmailValido(email) {
    var exprReg = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    return exprReg.test(String(email).toLowerCase());
}

/**
 * Función que utiliza una expresión regular para validar que el valor ingresado corresponda a una fecha en el formato
 * faaaa-mm-dd
 * @param fecha
 * @returns {boolean}
 */
function esFechaValida(fecha) {
    var exprReg = /^\d{4}-\d{2}-\d{2}$/;
    if(!fecha.match(exprReg)) {
        return false;
    }
    var d = new Date(fecha);
    if(Number.isNaN(d.getTime())) {
        return false;
    }
    return d.toISOString().slice(0,10) === fecha;
}

/**
 * Función que produce un resultado visible indicativo de un error de campo vacío. Específicamente, produce un borde
 * rojo en el input en cuestión, y además hace visible el mensaje de "Campo requerido".
 * En caso de que el valor reset sea verdadero, se deshacen las acciones mencionadas previamente.
 * @param id
 * @param reset
 */
function errorCampoVacio(id, reset=false) {
    var string = id + "-span";
    var boxShadow = "0 0 3px #CC0000";
    var display = "inline";
    if(reset) {
        boxShadow = "none";
        display = "none";
    }
    $(id).css({"box-shadow": boxShadow});
    $(string).css({"display": display});
}

/**
 * Función que genera las opciones de los selectores dados, correspondientes a las regiones y comunas de Chile
 * @param regiones
 * @param comunas
 */
function generarRegionesYComunas(regiones, comunas){
	var iRegion = 0;
	var htmlRegion = '<option disabled selected value="sin-region">Seleccionar región</option>';
	var htmlComunas = '<option disabled selected value="sin-region">Seleccionar comuna</option>';

	$.each(RegionesYcomunas.regiones, function () {
		htmlRegion = htmlRegion + '<option value="' + RegionesYcomunas.regiones[iRegion].NombreRegion + '">' +
			RegionesYcomunas.regiones[iRegion].NombreRegion + '</option>';
		iRegion++;
	});

	regiones.html(htmlRegion);
	comunas.html(htmlComunas);

	regiones.change(function () {
		var iRegiones = 0;
		var valorRegion = $(this).val();
		var htmlComuna = '<option disabled selected value="sin-comuna">Seleccionar comuna</option>';
		$.each(RegionesYcomunas.regiones, function () {
			if (RegionesYcomunas.regiones[iRegiones].NombreRegion == valorRegion) {
				var iComunas = 0;
				$.each(RegionesYcomunas.regiones[iRegiones].comunas, function () {
					htmlComuna = htmlComuna + '<option value="' + RegionesYcomunas.regiones[iRegiones].comunas[iComunas]
						+ '">' + RegionesYcomunas.regiones[iRegiones].comunas[iComunas] + '</option>';
					iComunas++;
				});
			}
			iRegiones++;
		});
		comunas.html(htmlComuna);
	});
}

